# 📅 Система календаря тренера

**Дата:** 15 января 2025  
**Статус:** Планирование  
**Версия:** 1.0

## 📋 Обзор системы

Полнофункциональная система календаря для тренеров с возможностью создания, редактирования, отмены и модификации тренировок через UI. 

**⚠️ Примечание:** В текущей итерации система работает с расписанием по дням недели. Функциональность конкретных дат и повторяющихся тренировок будет реализована в следующей версии календаря.

## 🎯 Цели системы

- ✅ **CRUD операции** - создание, чтение, обновление, удаление тренировок
- ✅ **Расписание по дням недели** - отображение тренировок по дням недели
- ✅ **Множественные тренеры** - поддержка нескольких тренеров на одном занятии
- ✅ **Авторизация тренеров** - доступ только для авторизованных тренеров
- ✅ **Интуитивный UI** - удобный интерфейс для управления расписанием
- 🔄 **Конкретные даты** - будет реализовано в следующей итерации
- 🔄 **Повторяющиеся тренировки** - будет реализовано в следующей итерации
- 🔄 **Система исключений** - будет реализовано в следующей итерации

## 🏗️ Архитектура системы

### 1. **Коллекция "schedule" (расписание)**
```
Поля:
- day (Select) - День недели
- start_time (Text) - Время начала (ЧЧ:ММ)
- end_time (Text) - Время окончания (ЧЧ:ММ)
- location (Relation) - Связь с коллекцией locations
- coaches (Relation) - Связь с коллекцией coaches (множественный выбор)
- level (Select) - Уровень подготовки
- is_active (Bool) - Активна ли тренировка
- sort_order (Number) - Порядок сортировки
- created_by (Relation) - Кто создал тренировку (тренер)
- created (DateTime) - Дата создания
- updated (DateTime) - Дата обновления
```

### 2. **Коллекция "schedule_exceptions" (исключения)**
```
Поля:
- parent_schedule_id (Relation) - Ссылка на основную тренировку
- exception_date (Date) - Дата исключения
- type (Select) - Тип: "cancelled" | "modified"
- is_cancelled (Bool) - Тренировка отменена
- cancellation_reason (Text) - Причина отмены
- new_start_time (Text) - Новое время начала
- new_end_time (Text) - Новое время окончания
- new_location (Relation) - Новая локация
- new_coaches (Relation) - Новые тренеры
- new_level (Select) - Новый уровень
- created_by (Relation) - Кто создал исключение
- created (DateTime) - Дата создания
- updated (DateTime) - Дата обновления
```

### 3. **Коллекция "trainer_sessions" (сессии тренеров)**
```
Поля:
- trainer_id (Relation) - Ссылка на тренера
- session_token (Text) - Токен сессии
- expires_at (DateTime) - Время истечения сессии
- is_active (Bool) - Активна ли сессия
- created (DateTime) - Дата создания
- updated (DateTime) - Дата обновления
```

## 🔧 Технические требования

### Frontend (React/Next.js)
- **Календарный виджет** - отображение недели с датами
- **Модальные окна** - для создания/редактирования тренировок
- **Формы валидации** - проверка корректности данных
- **Авторизация** - система входа для тренеров
- **Состояние приложения** - управление данными расписания

### Backend (PocketBase)
- **API endpoints** - CRUD операции для тренировок
- **Правила доступа** - ограничение доступа по ролям
- **Валидация данных** - проверка корректности полей
- **Связи между коллекциями** - правильная работа с relations

### Интеграции
- **Telegram Bot** - для авторизации тренеров
- **Уведомления** - оповещения об изменениях в расписании

## 📱 Пользовательские сценарии

### Сценарий 1: Создание повторяющейся тренировки
1. Тренер авторизуется в системе
2. Переходит в раздел "Мой календарь"
3. Нажимает "Создать тренировку"
4. Заполняет форму: день недели, время, локация, уровень
5. Отмечает "Повторяющаяся тренировка"
6. Сохраняет - тренировка появляется каждую неделю

### Сценарий 2: Отмена тренировки на конкретную дату
1. Тренер видит повторяющуюся тренировку в календаре
2. Нажимает на конкретную дату
3. Выбирает "Отменить тренировку"
4. Указывает причину отмены
5. Тренировка исчезает только для этой даты

### Сценарий 3: Изменение тренировки на конкретную дату
1. Тренер нажимает на тренировку в конкретной дате
2. Выбирает "Изменить тренировку"
3. Меняет время/локацию/тренера
4. Сохраняет - изменения применяются только к этой дате

## 🎨 UI/UX требования

### Календарный виджет
- **Недельный вид** - отображение текущей недели
- **Навигация** - переход между неделями
- **Цветовая кодировка** - разные цвета для разных типов тренировок
- **Индикаторы** - отмененные/измененные тренировки

### Формы создания/редактирования
- **Валидация в реальном времени** - проверка корректности данных
- **Автозаполнение** - предложения на основе предыдущих тренировок
- **Предпросмотр** - как будет выглядеть тренировка в календаре

### Мобильная адаптация
- **Responsive design** - корректное отображение на всех устройствах
- **Touch-friendly** - удобное управление на мобильных устройствах

## 🔐 Система авторизации

### Роли пользователей
- **Тренер** - может управлять своими тренировками
- **Администратор** - может управлять всеми тренировками
- **Гость** - может только просматривать расписание

### Процесс авторизации
1. Тренер переходит по ссылке в Telegram-боте
2. Бот проверяет, является ли пользователь тренером
3. Создается сессия с токеном
4. Токен сохраняется в localStorage
5. При каждом запросе токен проверяется

## 📊 Алгоритмы обработки данных

### Получение расписания на дату
```javascript
function getScheduleForDate(targetDate) {
  const dayOfWeek = getDayFromDate(targetDate);
  
  // 1. Получаем все повторяющиеся тренировки для дня недели
  const repeatableClasses = getRepeatableClasses(dayOfWeek);
  
  // 2. Получаем все исключения для этой даты
  const exceptions = getExceptionsForDate(targetDate);
  
  // 3. Применяем исключения
  const finalSchedule = repeatableClasses.map(classItem => {
    const exception = exceptions.find(ex => ex.parent_schedule_id === classItem.id);
    
    if (exception?.is_cancelled) {
      return null; // Тренировка отменена
    }
    
    if (exception?.type === 'modified') {
      return {
        ...classItem,
        ...exception, // Переопределяем поля
        date: targetDate
      };
    }
    
    return {
      ...classItem,
      date: targetDate
    };
  }).filter(Boolean);
  
  return finalSchedule;
}
```

### Валидация пересечений времени
```javascript
function validateTimeConflicts(newSchedule, existingSchedule) {
  return existingSchedule.some(existing => {
    return existing.coaches.some(coach => 
      newSchedule.coaches.includes(coach)
    ) && isTimeOverlapping(
      newSchedule.start_time, newSchedule.end_time,
      existing.start_time, existing.end_time
    );
  });
}
```

## 🚀 План реализации

### Этап 1: Подготовка инфраструктуры (1-2 дня)
- [ ] Создание коллекций в PocketBase
- [ ] Настройка правил доступа
- [ ] Создание базовых API endpoints
- [ ] Настройка авторизации через Telegram

### Этап 2: Базовый календарь (2-3 дня)
- [ ] Создание календарного виджета
- [ ] Отображение текущей недели
- [ ] Навигация между неделями
- [ ] Базовое отображение тренировок

### Этап 3: CRUD операции (3-4 дня)
- [ ] Создание тренировок
- [ ] Редактирование тренировок
- [ ] Удаление тренировок
- [ ] Валидация форм

### Этап 4: Система исключений (2-3 дня)
- [ ] Отмена тренировок на конкретные даты
- [ ] Изменение тренировок на конкретные даты
- [ ] Отображение исключений в календаре
- [ ] Управление исключениями

### Этап 5: Полировка и тестирование (1-2 дня)
- [ ] Мобильная адаптация
- [ ] Тестирование всех сценариев
- [ ] Оптимизация производительности
- [ ] Документация для пользователей

## 📝 Примечания

- Система должна быть готова к масштабированию
- Важна производительность при большом количестве тренировок
- Необходимо логирование всех изменений для аудита
- Система должна работать офлайн (с синхронизацией при подключении)

## 🔗 Связанные документы

- [PocketBase Collections Setup](./manuals/pocketbase/POCKETBASE_COLLECTIONS_SETUP.md)
- [Telegram Bot Integration](./manuals/telegram/TELEGRAM_BOT_SETUP.md)
- [UI/UX Guidelines](./manuals/design/UI_UX_GUIDELINES.md)
